<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IoT</title>

  <!-- Bootstrap -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">

  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Simple markers</title>
  <style>
      /* Always set the map height explicitly to define the size of the div
      * element that contains the map. */
      #map {
        height: 100%;
      }
      #legend {
        font-family: Arial, sans-serif;
        background: #fff;
        padding: 10px;
        margin: 10px;
        border: 3px solid #000;
      }
      #legend h3 {
        margin-top: 0;
      }
      #legend img {
        vertical-align: middle;
      }

      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map,
      #wrapper,
      #page-content-wrapper {
        height: 100%;
        width: 100%;
      }
      .container-fluid,
      .row,
      .col-lg-12 {
        height: 100%;
        width: 100%;
      }
    }
    /* hamburger menu pseudo element */

    .box-shadow-menu {
      position: relative;
      padding-left: 1.25em;
    }
    .box-shadow-menu:before {
      content: "";
      position: absolute;
      left: 0;
      top: 0.25em;
      width: 1em;
      height: 0.15em;
      background: black;
      box-shadow: 0 0.25em 0 0 black, 0 0.5em 0 0 black;
    }
    /* hamburger menu pseudo element gradient */

    .gradient-menu {
      padding-left: 1.25em;
      position: relative;
    }
    .gradient-menu:before {
      content: "";
      position: absolute;
      left: 0;
      top: 0.21em;
      bottom: 0.21em;
      width: 1em;
      background: linear-gradient(to bottom, black, black 20%, white 20%, white 40%, black 40%, black 60%, white 60%, white 80%, black 80%, black 100%);
    }
    /* http://www.jqueryscript.net/demo/Bootstrap-Sidebar-Extension-With-jQuery-CSS-CSS3/ */

    /*!
     * Start Bootstrap - Simple Sidebar HTML Template (http://startbootstrap.com)
     * Code licensed under the Apache License v2.0.
     * For details, see http://www.apache.org/licenses/LICENSE-2.0.
     */

     /* Toggle Styles */

     .nav-tabs>li {
      float: none;
    }
    .nav-tabs {
      border-bottom: 0;
    }
    .nav-tabs>li.active>a,
    .nav-tabs>li.active>a:focus,
    .nav-tabs>li.active>a:hover {
      margin: 0;
      border-radius: 0;
    }
    #wrapper {
      padding-left: 0;
      -webkit-transition: all 0.5s ease;
      -moz-transition: all 0.5s ease;
      -o-transition: all 0.5s ease;
      transition: all 0.5s ease;
    }
    #wrapper.toggled {
      padding-left: 250px;
    }
    #sidebar-wrapper {
      z-index: 1000;
      position: fixed;
      left: 250px;
      width: 0;
      height: 100%;
      margin-left: -250px;
      overflow-y: auto;
      background: #a9cce3;
      -webkit-transition: all 0.5s ease;
      -moz-transition: all 0.5s ease;
      -o-transition: all 0.5s ease;
      transition: all 0.5s ease;
    }
    #wrapper.toggled #sidebar-wrapper {
      width: 250px;
    }
    #page-content-wrapper {
      width: 100%;
      position: absolute;
      padding: 15px;
    }
    #wrapper.toggled #page-content-wrapper {
      position: absolute;
      margin-right: -250px;
    }
    /* Sidebar Styles */

    .sidebar-nav {
      position: absolute;
      top: 0;
      width: 250px;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .sidebar-nav li {
      text-indent: 20px;
      line-height: 40px;
    }
    .sidebar-nav li a {
      display: block;
      text-decoration: none;
      color: #000000;
    }
    .sidebar-nav li a:hover {
      text-decoration: none;
      color: #000080;
      background: rgba(255, 255, 255, 0.2);
    }
    .sidebar-nav li a:active,
    .sidebar-nav li a:focus {
      text-decoration: none;
      /*display: inline-block;*/
    }
    .sidebar-nav > .sidebar-brand {
      height: 65px;
      font-size: 18px;
      line-height: 60px;
    }
    .sidebar-nav > .sidebar-brand a {
      color: #999999;
    }
    .sidebar-nav > .sidebar-brand a:hover {
      color: #fff;
      background: none;
    }
    @media(min-width:768px) {
      #wrapper {
        padding-left: 250px;
      }
      #wrapper.toggled {
        padding-left: 0;
      }
      #sidebar-wrapper {
        width: 250px;
      }
      #wrapper.toggled #sidebar-wrapper {
        width: 0;
      }
      #page-content-wrapper {
        padding: 20px;
        position: relative;
      }
      #wrapper.toggled #page-content-wrapper {
        position: relative;
        margin-right: 0;
      }
    }
    ul {
      text-align: left;
      /*display:inline-block;*/
      /*box-sizing:border-box;*/
      /*padding-left: 5px;*/
    }
    .ulleft {
      display: inline;
      float: left;
    }
    .ulright {
      display: inline;
      float: right;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      filter:alpha(opacity=50);
      -moz-opacity:0.5;
      -khtml-opacity: 0.5;
      opacity: 0.8;
      z-index: 10000;
    }
    #confirm{
      color: black;
    }
    #text{
      position: absolute;
      top: 50%;
      left: 50%;
      font-size: 50px;
      color: white;
      transform: translate(-50%,-50%);
      -ms-transform: translate(-50%,-50%);
    }
    #myBtn {
      display: none;
      position: fixed;
      bottom: 5px;
      left: 250px;
      z-index: 99;
      border: none;
      outline: none;
      background-color: black;
      color: white;
      cursor: pointer;
      padding: 5px;
      border-radius: 50px;
      font-size: 40px;
      height: 50px;
      width: 50px;
    }

    #myBtn:hover {
      background-color: #555;
    }

    #mapresetbtn {
      /*position: fixed;*/
      bottom: 5px;
      left: 250px;
      z-index: 99;
      border: none;
      outline: none;
      background-color: black;
      color: white;
      cursor: pointer;
      padding: 5px;
      border-radius: 50px;
      font-size: 40px;
      height: 50px;
      width: 50px;
      margin: 10px;
    }
    #mapresetbtn:hover{
      background-color: #555;
    }

    hr {
      display: block;
      border: 2px solid;
      border-top: 1px solid #ccc;
      margin: 1em 0;
      padding: 0; 
      border-color: #000000;
    }
    #container {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 0;
      right: 0;
      background-color: #a9cce3;
      overflow-x: hidden;
      transition: 0.5s;
      /*padding-top: 60px;*/
    }
    .sidenav a {
      padding: 8px 8px 8px 32px;
      text-decoration: none;
      font-size: 25px;
      color: #818181;
      display: block;
      transition: 0.3s;
    }

    .sidenav a:hover, .offcanvas a:focus{
      color: #f1f1f1;
    }


    .sidenav .closebtn {
      /*position: absolute;*/
      top: 0;
      right: 25px;
      font-size: 46px;
      /*margin-left: 50px;*/
    }
    @media screen and (max-height: 450px) {
      .sidenav {padding-top: 15px;}
      .sidenav a {font-size: 18px;}
    }
    #toolkit {
      display: inline-block;
      padding-left: 50px;
    }
    #close{
      float: right;
    }
    #divleft{
      display: inline-block;
    }
    #divmid{
      display: inline-block;
      padding-left: 10px;
    }
    #divright{
      display: inline-block;
      padding-left: 10px;
    }
    #myProgress {
      width: 100%;
      background-color: #ddd; 
    }
    #myBar {
      width: 0%;
      height: 30px;
      background-color: #4CAF50;
      text-align: center; /* To center it horizontally (if you want) */
      line-height: 30px; /* To center it vertically */
      color: white; 
    }

  </style>


</head>

<body>
  <div class="container">
    <h1>Network Performance Map: Noisy Zone</h1>
  </div>
  <div id="myProgress">
    <div id="myBar">0%</div>
  </div>
  <div id="wrapper" class="toggled">
    <div id="sidebar-wrapper">
      <button onclick="topFunction()" id="myBtn" title="Go to top">&#8963;</button>
      <ul class="sidebar-nav" id="side_bar">
        <li class="sidebar-brand" style="font-weight: bold; color: #000000;">
          <h1>Summary</h1>
        </li>
        <hr>
        <div id="demo" class="collapse"></div>
        <div id="demo2" class="collapse"></div>
      </ul>
    </div>
    <div id="page-content-wrapper">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-12">
            <h1>
              <span style="font-size:50px;cursor:pointer;float:right" onclick="openNav()">&#9881;</span>
              <a href="#menu-toggle" class="gradient-menu" id="menu-toggle"></a>
            </h1>
            <div id="mySidenav" class="sidenav">
              <h1 id="toolkit">Toolkit</h1>
              <b>
                <a id="close" href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
              </b>
              <hr>

              <div style="padding:30px">Choose analytic task:
                <p>
                  <select id="box1" name="task" style="max-width:90%;">
                    <option selected disabled>Choose one</option>
                    <optgroup label="Node aspect">
                      <option value="health">Health monitoring</option>
                      <option value="fault">Fault detection</option>
                      <option value="maintenance">Maintenance recommendation</option>
                    </optgroup>
                    <optgroup label="Node aspect">
                      <option value="topology">Topology comparision and optimization</option>
                      <option value="network">Network reliability</option>
                      <option value="giwsns">GIWSNs</option>
                    </optgroup>
                    <optgroup label="Environment aspect">
                      <option value="noisy">Spatial-temporal noisy zone detection</option>
                      <option value="intervention">Surrounding intervention</option>
                    </optgroup>
                  </select>
                </p>
              </div>

              <div style="padding:30px">Choose target: 
                <p>
                  <select id="box2" name="target" style="max-width:90%;">
                    <option selected disabled>Choose one</option>
                    <option value="network1">Network 1</option>
                    <option value="network2">Network 2</option>
                    <option value="network3">Network 3</option>
                    <option value="network4">Network 4</option>
                  </select>
                </p>
              </div>

              <div style="padding:30px">
                <form action="javascript:analyze();">
                  <input type="submit" value="Run">
                </form>
              </div>

              <hr>

              <div id="numbox" style="padding: 10px; display: none">
                <p>
                  <select id="box3" name="num" style="max-width:90%;" onchange="selectfunction()">
                    <option selected="selected" value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                  </select>
                </p>
              </div>

              <div id="result" style="padding:10px; width: 450px; height: 240px;">
                <textarea id="mytext" rows="20" cols="35">Result goes here.</textarea>  
              </div>

              <div id="reset" style="padding:10px; position: absolute; bottom: 0; right: 0">
                <input type="button" value="Reset" onclick="javascript:eraseText();"> 
              </div>


            </div>
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="antixss.js" type="text/javascript"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <script src="//cdn.jsdelivr.net/webshim/1.14.5/polyfiller.js"></script>

  <script type="text/javascript">
    function openNav() {
      document.getElementById("mySidenav").style.width = "450px";
    }

    function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
    }

    function eraseText(){
      document.getElementById('mytext').value = "";
    }

    function viewchart(marker){
      var node_id = parseInt(marker.label);
      var node_data = getCustomInfo(marker);
      var node_time = getCustomInfoTime(marker);
      var data = new google.visualization.DataTable();
      data.addColumn('date','TIME');
      data.addColumn('number','PER');
      data.addColumn('number','RSSI');
      var temp_length = node_data.length;
      for(var i=0;i<node_data.length;i++){
        var time_data = convertTime(node_time[i]);
        if(parseFloat(node_data[i][0]) != 0){
          var avg_per_data = parseFloat(node_data[i][1]) / parseFloat(node_data[i][0]) * 100;
        }else{
          var avg_per_data = 1;
        }
        var sum_rssi_data = 0;
        for(var j=2; j<node_data[i].length;j++){
          sum_rssi_data += parseFloat(node_data[i][j]);
        }
        var avg_rssi_data = sum_rssi_data / (node_data[i].length -2);    

        data.addRow([time_data, avg_per_data, avg_rssi_data]);
      }
      var node = document.createElement('div');
      node.setAttribute('id', 'node');
      node.style.height = "250px";
      var chart = new google.visualization.AnnotatedTimeLine(node);
      var chart_start_date = $("#chart_start_date").val();
      var chart_end_date = $("#chart_end_date").val();
      var options = {
        title: '',
        width: 600,
        legend: { position: 'none' },
        displayAnnotations: true,
        scaleType:'allfixed',
      };
      chart.draw(data, options);
    }

    function confirm(){
      window.location = window.location + '#loaded';
      window.location.reload();
    }

    function analyze(){
      if($("#box1").val()=="giwsns" && $("#box2").val()=="network1"){
        var similarity_string = "\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 Event similarity \n\n";
        for(var i=3;i<21;i++){
          similarity_string += "Node" + i + ": \n"
          var curr_dict = checkSimilarity(i);
          for(var j=0;j<curr_dict.length;j++){
            curr_dict.sort(compare_rate);
            similarity_string += "\xa0\xa0 Node " + curr_dict[j][0] + "\xa0\xa0\xa0\xa0\xa0\xa0 similarity rate " + (curr_dict[j][1]*100).toFixed(2) + "% \n";
          }
          similarity_string += "\n";
        }
        document.getElementById('mytext').value = similarity_string;
      }
      else if($("#box1").val()=="fault" && $("#box2").val()=="network1"){
        document.getElementById('numbox').style.display = "block";
        var fault_val = $("#box3").val();
        faultDetection(parseInt(fault_val));
        var time_string = "\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 Fault time period \n\n";
        for(var i=0;i<array_time.length;i++){
          var current_string = convertTime2(array_time[i][0]) + " - " + convertTime2(array_time[i][1]) + "\n";
          time_string += current_string;
        }
        google.charts.load('current', {'packages':['annotatedtimeline']});
        google.charts.setOnLoadCallback(drawHistogram);

      }
    }

    function convertTimeView(raw_time){
      var date_array = raw_time.split("-");
      var year = date_array[0];
      var month = date_array[1];
      var day = date_array[2];
      var result_time = new Date(year, month, day);
      return result_time;
    }

    function convertTime4(date_string, time_string){
      var date_temp_array = date_string.split('-');
      var time_temp_array = time_string.split(':');
      return new Date(date_temp_array[0], date_temp_array[1]-1, date_temp_array[2], time_temp_array[0], time_temp_array[1], time_temp_array[2], 0);
    }

    function conditionalDivision(a,b){
      if(b==0){
        return 0;
      }else if(a>b){
        return 1;
      }else{
        return a/b;
      }
    }

    var chart2; 
    var data2;
    var options2;
    var curr_marker;
    var data_corr;
    function update(){
      chart2.hideDataColumns(0);
      chart2.hideDataColumns(1);
      chart2.hideDataColumns(2);
      var chart_start_date = new Date($('#chart_start_date').val().toString());
      var chart_end_date = new Date($('#chart_end_date').val().toString());            
      if(document.getElementById('app_per').checked){
        chart2.showDataColumns(0);
      }
      if(document.getElementById('mac_per').checked){
        chart2.showDataColumns(1);
      }
      if(document.getElementById('rssi').checked){
        chart2.showDataColumns(2);
      }
      chart2.draw(data2, options2);
      if(!isNaN(chart_start_date) && !isNaN(chart_end_date)){
        chart2.setVisibleChartRange(chart_start_date, chart_end_date);
      } 
    }

    function drawCorr(){
      var options_corr = {};
      var node_corr = document.createElement('div');
      var infoWindow_corr  = new google.maps.InfoWindow();
      var chart_corr = new google.visualization.ScatterChart(node_corr);
      chart_corr.draw(data_corr, options_corr);
      infoWindow_corr.setContent(node_corr);
      infoWindow_corr.open(curr_marker.getMap(),marker);
    }

    function compare(){
      var comp_id1 = parseInt(curr_marker.id);
      var comp_id2 = $('#selectcomp').val();
      $.ajax({
        url: "/api/sensor",
        dataType: "json",
        success: function(jsonData){
          var data_comp = new google.visualization.DataTable();
          data_comp.addColumn('date', 'TIME')
          data_comp.addColumn('number', 'MAC_PER'+comp_id1);
          data_comp.addColumn('number', 'MAC_PER'+comp_id2);
          for(var i=0; i<jsonData[comp_id1].length;i++){
            var data_comp_time = convertTime4(jsonData[comp_id1][i]['DATE'], jsonData[comp_id1][i]['TIME']);
            var data_comp_mac_tx_total1 = jsonData[comp_id1][i]['MAC_TX_TOTAL'];
            var data_comp_mac_tx_fail1 = jsonData[comp_id1][i]['MAC_TX_FAIL'];
            var data_comp_mac_tx_total2 = jsonData[comp_id2][i]['MAC_TX_TOTAL'];
            var data_comp_mac_tx_fail2 = jsonData[comp_id2][i]['MAC_TX_FAIL'];
            data_comp.addRow([data_comp_time, conditionalDivision(data_comp_mac_tx_fail1, data_comp_mac_tx_total1)*100, conditionalDivision(data_comp_mac_tx_fail2, data_comp_mac_tx_total2)*100]);
          }
          var options_comp = {};
          var node_comp = document.createElement('div');
          var infoWindow_comp = new google.maps.InfoWindow();
          var chart_comp = new google.visualization.AnnotatedTimeLine(node_comp);
          chart_comp.draw(data_comp, options_comp);
          infoWindow_comp.setContent(node_comp);
          infoWindow_comp.open(curr_marker.getMap(), marker);
        }
      })
    }

    function selectfunction(){
      var fault_val = $("#box3").val();
      array_time_all = [];
      faultDetection(parseInt(fault_val));
      google.charts.load('current', {'packages':['annotatedtimeline']});
      google.charts.setOnLoadCallback(drawHistogram);
    }

    function drawHistogram(){
      var data_hist = new google.visualization.DataTable();
      data_hist.addColumn('date','TIME');
      data_hist.addColumn('number','FREQ');
      for(var i=0;i<array_time_all.length;i++){
        data_hist.addRow([convertTime3(array_time_all[i][0].toString()), parseInt(array_time_all[i][1])]);
      }

      var options = {
        title: 'Fault detection',
        legend: { position: 'none' },
        displayAnnotations: true,
      };

      var chart_hist = new google.visualization.AnnotatedTimeLine(document.getElementById('result'));
      chart_hist.draw(data_hist, options);

    }

    function convertTime3(timestamp_string){
      var timestamp = parseInt(timestamp_string);
      var date = new Date(timestamp);
      var year = date.getFullYear();
      var month = date.getMonth();
      var day = date.getDate();
      var hours = date.getHours();
      var minutes = "0" + date.getMinutes();
      var seconds = "0" + date.getSeconds();
      var formattedTime = year + '/' + month + '/' + day + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
      var result_time = new Date(year, month, day, hours, minutes.substr(-2), seconds.substr(-2));
      return result_time;

    }

    function convertTime2(timestamp_string){
      var timestamp = parseInt(timestamp_string);
      var date = new Date(timestamp);
      var year = date.getFullYear();
      var month = date.getMonth();
      var day = date.getDate();
      var hours = date.getHours();
      var minutes = "0" + date.getMinutes();
      var seconds = "0" + date.getSeconds();
      var formattedTime = year + '/' + month + '/' + day + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
      return formattedTime;
    }

    function checkSimilarity(id1){
      var similarity_dict = [];
      for(var id2 = 3;id2<21;id2++){
        if(data_test[id1] && data_test[id2] && id2!=id1){
          var arrayA = [];
          var arrayB = [];
          for(var i=0;i<data_test[id1].length;i++){
            arrayA[i] = data_test[id1][i][1];
          }
          for(var j=0;j<data_test[id2].length;j++){
            arrayB[j] = data_test[id2][j][1];
          }
          var matches = 0;
          for (i=0;i<arrayA.length;i++) {
            if (Math.abs(arrayA[i]-arrayB[i])/arrayB[i] < 0.2)
              matches++;
          }
          var similarity_rate = matches/Math.min(arrayA.length, arrayB.length);
          if(similarity_rate > 0.2){
            similarity_dict.push([id2, similarity_rate]);
          }
        }
      }
      return similarity_dict;
    }

    function compare_rate(a,b){
      return b[1] - a[1];
    }

    var array_time = [];
    var array_time_all = [];
    function faultDetection(num){
      var min_length = 0;
      var time_start = null;
      var time_end = null;
      for(var id=3;id<19;id++){
        min_length = Math.min(data_test[id].length, data_test[id+1].length);
      }
      for(var i=0;i<min_length;i++){
        var fault_count = 0;
        for(var id=3;id<20;id++){
          if(data_test[id][i][1] > 0.05){
            fault_count++;
          }
        }
        if(fault_count >= 7){
          if(time_start){
            time_end = data_test[id][i][0];
          }
          else{
            time_start = data_test[id][i][0];
          }
        }

        if(fault_count >= num){
          array_time_all.push([data_test[id][i][0].toString(), fault_count]);
        }
        if(time_start && time_end){
          if(array_time.indexOf([time_start, time_end]) == -1){
            array_time.push([time_start, time_end]);
            time_start = null;
            time_end = null;
          }
        }
      }
    }
  </script>

  <script>
    	//Submit data when enter key is pressed
        // $('#user_name').keydown(function(e) {
        // 	var name = $('#user_name').val();
        //     if (e.which == 13 && name.length > 0) { //catch Enter key
        //     	//POST request to API to create a new visitor entry in the database
        //         $.ajax({
        //           method: "POST",
        //           url: "./api/sensor",
        //           contentType: "application/json",
        //           data: JSON.stringify({name: name })
        //       })
        //         .done(function(data) {
        //             $('#response').html(AntiXSS.sanitizeInput(data));
        //             $('#nameInput').hide();
        //             getNames();
        //         });
        //     }
        // });

        var data_gateway_test = [];
        function getGateway(){
          $.get("./api/gateway")
          .done(function(data){
            for(var i=0;i<data.length;i++){
              data_gateway_test[i] = data[i];
            }
            if(data.length>0){
              data.forEach(function(element, index){
                data[index] = AntiXSS.sanitizeInput(element)
              });
            }
          });
        }


        //Retreive all the visitors from the database
        var sensorComplete = false;
        var data_test = [];
        function getSensor(){
          $.get("./api/sensor")
          .done(function(data) {
            for(var i=0;i<data.length;i++){
              data_test[i] = data[i];
            }
            sensorComplete = true;
            if(data.length > 0) {
              data.forEach(function(element, index) {
                data[index] = AntiXSS.sanitizeInput(element)
              });
            }
          });
        }

        var data_topo_test = [];
        function getTopology(){
          $.get("./api/topology")
          .done(function(data){
            for(var i=0;i<data.length;i++){
              data_topo_test[i] = data[i];
            }
            if(data.length>0){
              data.forEach(function(element, index){
                data[index] = AntiXSS.sanitizeInput(element)
              });
            }
          });
        }

      </script>

      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
      <script type="text/javascript" src="https://www.google.com/jsapi"></script>
      <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
      <script type="text/javascript">
        var map;
        function mapReset(){
          map.setZoom(5);
          map.setCenter(new google.maps.LatLng(41.850033, -87.6500523));
        }
      </script>
      <div id="gateway" style="font-size:20px; background-color: lightblue; margin-left: 10px;">
       Gateway:
       <select id=gateway_names></select> 
     </div>
     <div id="mapreset">
      <button id="mapresetbtn" type="button" onclick="mapReset()">&#8634;</button>
    </div>
    <div id="legend"><h3>Status</h3>
      <canvas id="myCanvas" width="150" height="40">
      </div>


      <script>
        var marker;
        var markers = [];
        var links = [];
        var markers_location = [];
        var markers2 = [];
        var sum_network = 0;
        var sum_network_rssi = 0;
        var zoomChange = null;


        function initMap() {

          var myWrapper = $("#wrapper");
          $("#menu-toggle").click(function(e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
            if($("#wrapper").hasClass("toggled")){
              document.getElementById("myBtn").style.display = "none";
            }
            myWrapper.one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function(e) {
              google.maps.event.trigger(map, 'resize');
            });
          });

          map = new google.maps.Map(document.getElementById('map'), {
            zoom: 5,
            center: new google.maps.LatLng(41.850033, -87.6500523)
          });

          google.maps.event.addListener(map, 'click', function() {
            infowindow.close();
            clearInterval(myinterval);
          });

          var iconBase = 'http://labs.google.com/ridefinder/images/';

          var icons = {
            active: {
              name: 'Active',
              icon: iconBase + 'mm_20_green.png'
            },
            warning: {
              name: 'Warning',
              icon: iconBase + 'mm_20_orange.png'
            },
            critical: {
              name: 'Critical',
              icon: iconBase + 'mm_20_red.png'
            }
          };

          var contentString = '<div id="content">'+
          '<div id="siteNotice">'+
          '</div>'+
          '<h1 id="firstHeading" class="firstHeading">PER</h1>'+
          '<div id="bodyContent">'+
          '<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large ' +
          'sandstone rock formation in the southern part of the '+
          'Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) '+
          'south west of the nearest large town, Alice Springs; 450&#160;km '+
          '(280&#160;mi) by road. Kata Tjuta and Uluru are the two major '+
          'features of the Uluru - Kata Tjuta National Park. Uluru is '+
          'sacred to the Pitjantjatjara and Yankunytjatjara, the '+
          'Aboriginal people of the area. It has many springs, waterholes, '+
          'rock caves and ancient paintings. Uluru is listed as a World '+
          'Heritage Site.</p>'+
          '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">'+
          'https://en.wikipedia.org/w/index.php?title=Uluru</a> '+
          '(last visited June 22, 2009).</p>'+
          '</div>'+
          '</div>';

          var infowindow = new google.maps.InfoWindow({
            content: contentString,
          });

          var markerCluster1 = new MarkerClusterer(map, markers_location,
          {
            maxZoom: 15,
            imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
            ignoreHidden: true
          });
          loadGateway();
          drawTopology();

          // addNetwork(markers,1);
          addNetwork(markers2,2);

          updateGateway();

          function convertTime(timestamp_string){
            var timestamp = parseInt(timestamp_string);
            var date = new Date(timestamp);
            var year = date.getFullYear();
            var month = date.getMonth();
            var day = date.getDate();
            var hours = date.getHours();
            var minutes = "0" + date.getMinutes();
            var seconds = "0" + date.getSeconds();
            var formattedTime = year + '/' + month + '/' + day + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
            var result_time = new Date(year, month, day, hours, minutes.substr(-2), seconds.substr(-2));
            return result_time;
          }

          function findLineByLeastSquares(values_x, values_y) {
            var sum_x = 0;
            var sum_y = 0;
            var sum_xy = 0;
            var sum_xx = 0;
            var count = 0;
            var x = 0;
            var y = 0;
            var values_length = values_x != null ? values_x.length : 0;
            if (values_length === 0) {
              return [ [], [] ];
            }
            for (var v = 0; v < values_length; v++) {
              x = values_x[v];
              y = values_y[v];
              sum_x += x;
              sum_y += y;
              sum_xx += x*x;
              sum_xy += x*y;
              count++;
            }
            var m = (count*sum_xy - sum_x*sum_y) / (count*sum_xx - sum_x*sum_x);
            var b = (sum_y/count) - (m*sum_x)/count;
            var result_values_x = [];
            var result_values_y = [];

            for (var v = 0; v < values_length; v++) {
              x = values_x[v];
              y = x * m + b;
              result_values_x.push(x);
              result_values_y.push(y);
            }
            return [result_values_x, result_values_y];
          }
          function getCustomInfo(marker){
            return marker.customInfo;
          }
          function getCustomInfoTime(marker){
            return marker.customInfoTime;
          }
          function getMarker(id){
            return markers[parseInt(id)];
          }
          function generateRandom(){
            return Math.random() * (0.06 - 0.00) + 0.00;
          }
          function calcMid(marker){
            var parent_id = marker.parentInfo;
            var parent_marker = getMarker(parent_id);
            if(parent_marker){
              var x = (marker.getPosition().lat() + parent_marker.getPosition().lat())/2;
              var y = (marker.getPosition().lng() + parent_marker.getPosition().lng())/2;
              var midpoint = new google.maps.LatLng(x, y);
              return midpoint;
            }
          }
          function calcDistance(marker1,marker2){
            var x = marker1.getPosition().lat() - marker2.getPosition().lat();
            var y = marker1.getPosition().lng() - marker2.getPosition().lng();
            var distance = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
            return distance;
          }
          function getParent(marker){
            var parent_id = marker.parentInfo;
            var parent_marker = getMarker(parent_id);
            return parent_marker;
          }
          function searchArea(position, area){
            if(area.shapeType == 1){
              var center = area.getCenter();
              var radius = area.getRadius();
              if(google.maps.geometry.spherical.computeDistanceBetween(position, center) < radius){
                return true;

              }else{
                return false;
              }
            }else if(area.shapeType == 0){
              return google.maps.geometry.poly.containsLocation(position, area);
            }else{
              return false;
            }
          }

          function markMarker(marker){
            if(marker.isCritical == 1){
              var cityCircle = new google.maps.Circle({
                strokeColor: '#FF5733',
                strokeOpacity: 0,
                strokeWeight: 0,
                fillColor: '#FF5733',
                fillOpacity: 0.2,
                map: map,
                center: marker.getPosition(),
                radius: Math.sqrt(marker.lossRate)
              });
            }
          }

          var shapes = [];
          function markRegion(){
            while(markers.length > 0){
              var current_marker = markers.pop();
              if(current_marker && current_marker.isCritical==1){
                var cluster = [];
                var affected = [];
                var sum_lossRate_mult = current_marker.lossRate;
                var sum_lossRate = current_marker.lossRate*0.05;
                affected.push(current_marker.label);
                while(getParent(current_marker) && getParent(current_marker).isCritical==1){
                  var first_marker = current_marker;
                  sum_lossRate_mult += current_marker.lossRate;
                  sum_lossRate += current_marker.lossRate*0.05;
                  current_marker = getParent(current_marker);
                  var second_marker = current_marker;
                  sum_lossRate_mult += current_marker.lossRate;
                  sum_lossRate += current_marker.lossRate*0.05;
                  affected.push(current_marker.label);
                  cluster.push(current_marker.getPosition());
                }
                var avg_lossRate_mult = sum_lossRate_mult / cluster.length;
                var avg_lossRate = sum_lossRate / cluster.length;
                if(cluster.length > 2){
                  var shape = new google.maps.Polygon({
                    paths: cluster,
                    strokeColor: ' #FF5733 ',
                    strokeOpacity: 0,
                    strokeWeight: 0,
                    fillColor: ' #FF5733 ',
                    fillOpacity: 0.2 * avg_lossRate_mult,
                    lossInfo: avg_lossRate,
                    shapeType: 0,
                    affected: affected
                  });

                  shape.setMap(map);
                  shapes.push(shape);
                }
                else if(cluster.length == 2){
                  var cityCircle = new google.maps.Circle({
                    strokeColor: '#FF5733',
                    strokeOpacity: 0,
                    strokeWeight: 0,
                    fillColor: '#FF5733',
                    fillOpacity: 0.2 * avg_lossRate_mult,
                    map: map,
                    center: calcMid(first_marker),
                    radius: calcDistance(first_marker,second_marker)/2*100000+4,
                    lossInfo: avg_lossRate,
                    shapeType: 1,
                    affected: affected
                  });
                  shapes.push(cityCircle);
                }
              }
            }
          }
          function drawAdditionalHAxis(chart,dataTable){
            var layout = chart.getChartLayoutInterface();
            var chartArea = layout.getChartAreaBoundingBox();
            var svg = chart.getContainer().getElementsByTagName('svg')[0];
            var lastVal = 0.05;
            var yLoc = layout.getYLocation(lastVal);
            svg.appendChild(createLine(chartArea.left,yLoc,chartArea.width + chartArea.left,yLoc,'#FF0000',3,2));
            svg.appendChild(createText(chartArea.width + chartArea.left + 20 ,yLoc + 5,'Arial','13','red',lastVal)); 
          }
          function createLine(x1, y1, x2, y2, color, w, dash) {
            var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke', color);
            line.setAttribute('stroke-width', w);
            line.setAttribute('stroke-dasharray', dash);
            return line;
          }

          function createText(x, y, fontFamily, fontSize,fontColor,value) {
            var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            text.setAttribute('y', y);
            text.setAttribute('font-family', fontFamily);
            text.setAttribute('font-size', fontSize);
            text.setAttribute('fill', fontColor);
            text.innerHTML = value;
            return text;
          }

          function createInfoWindow(poly, content) {  
            google.maps.event.addListener(poly, 'click', function(event) {
              infowindow.setContent(content);
              infowindow.setPosition(event.latLng);
              infowindow.open(map);
            });
          }

          function drawInsideHistogram(data_point, marker){
            var node_data = getCustomInfo(marker);                            
            var data_his = google.visualization.arrayToDataTable([
              ['channel', 'RSSI'],
              ['CH11', parseFloat(node_data[data_point][2])],
              ['CH12', parseFloat(node_data[data_point][3])],
              ['CH13', parseFloat(node_data[data_point][4])],
              ['CH14', parseFloat(node_data[data_point][5])],
              ['CH15', parseFloat(node_data[data_point][6])],
              ['CH16', parseFloat(node_data[data_point][7])],
              ['CH17', parseFloat(node_data[data_point][8])],
              ['CH18', parseFloat(node_data[data_point][9])],
              ['CH19', parseFloat(node_data[data_point][10])],
              ['CH20', parseFloat(node_data[data_point][11])],
              ['CH21', parseFloat(node_data[data_point][12])],
              ['CH22', parseFloat(node_data[data_point][13])],
              ['CH23', parseFloat(node_data[data_point][14])],
              ['CH24', parseFloat(node_data[data_point][15])],
              ['CH25', parseFloat(node_data[data_point][16])],
              ]);
            var options_his = {
              'legend':'top',
              width: 700,
            };
            var node_his = document.createElement('div');
            var infoWindow_his  = new google.maps.InfoWindow();
            var chart_his = new google.visualization.ColumnChart(node_his);
            chart_his.draw(data_his, options_his);
            infoWindow_his.setContent(node_his);
            infoWindow_his.open(marker.getMap(),marker);
          }


          function drawChart(marker,avg,current,predict,fault_pbb) {
            var node_id = parseInt(marker.label);
            var node_data = getCustomInfo(marker);
            var node_time = getCustomInfoTime(marker);
            data = new google.visualization.DataTable();
            data.addColumn('date','TIME');
            data.addColumn('number','APP_PER');
            data.addColumn('number','MAC_PER');
            data.addColumn('number','RSSI');
            var temp_length = node_data.length;
            for(var i=0;i<node_data.length;i++){
              var time_data = convertTime(node_time[i]);
              if(parseFloat(node_data[i][0]) != 0){
                var avg_per_data = parseFloat(node_data[i][1]) / parseFloat(node_data[i][0]) * 100;
              }else{
                var avg_per_data = 1;
              }
              var sum_rssi_data = 0;
              for(var j=4; j<node_data[i].length;j++){
                sum_rssi_data += parseFloat(node_data[i][j]);
              }
              var avg_rssi_data = sum_rssi_data / (node_data[i].length -2);    

              data.addRow([time_data, avg_per_data, avg_rssi_data]);
            }

            jQuery.swap = function( elem, options, callback, args ) {
              var ret, name, old = {};
              for ( name in options ) {
                old[ name ] = elem.style[ name ];
                elem.style[ name ] = options[ name ];
              }

              ret = callback.apply( elem, args || [] );
              for ( name in options ) {
                elem.style[ name ] = old[ name ];
              }                                                                                                               
              return ret;
            };

            webshims.setOptions('forms-ext', {types: 'date'});
            webshims.polyfill('forms forms-ext');


            options = {
              title: 'PER'+'\n'+'current: '+(parseFloat(current)*100).toFixed(2)+'%'+'\xa0\xa0'+'predicted: '+(parseFloat(predict)*100).toFixed(2)+'%'+'\xa0\xa0'+'fault probability: '+(fault_pbb*100).toFixed(2)+'%',
              width: 600,
          // height: 800,
          legend: { position: 'none' },
          displayAnnotations: true,
          scaleType:'allfixed',
        };

        var node = document.createElement('div');
        node.setAttribute('id', 'node');
        node.style.height = "250px";
        chart = new google.visualization.AnnotatedTimeLine(node);
        google.visualization.events.addListener(chart, 'select', selectHandler);
        function selectHandler(e) {
          var selected = chart.getSelection()[0].row;
          drawInsideHistogram(selected, marker);
        }
        var div = document.createElement('div');

        var titlestring = '<div id="content">'+
        '<h1 id="firstHeading" class="firstHeading">PER vs. RSSI</h1>'+
        '<div id="bodyContent">'+
        '<p><b>Average: </b>'+(parseFloat(avg)*100).toFixed(2)+'%'+'</p>'+
        '<p><b>Current: </b>'+(parseFloat(current)*100).toFixed(2)+'%'+'</p>'+
        '<p><b>Predicted: </b>'+(parseFloat(predict)*100).toFixed(2)+'%'+'</p>'+
        '<p><b>Fault probability: </b>'+(fault_pbb*100).toFixed(2)+'%'+'</p>'+
        '<p>'+'Start date: <input type="date" id="chart_start_date" />'+'</p>'+
        '<p>'+'End date: <input type="date" id="chart_end_date" />'+'</p>'+
        '<p>'+'Metric: <input type="checkbox" value="app_per" id="app_per" />Application Layer PER<input type="checkbox" value="mac_per" id="mac_per" />Mac Layer PER<input type="checkbox" value="rssi" id="rssi" />RSSI'+'</p>'+
        '</div>'+
        '</div>'+
        '<div><form action="javascript:update();"><input type="submit" value="Update"></form></div>'+
        '<div><form action="javascript:viewCorr();"><input type="submit" value="View correlation"></form></div>';

        div.innerHTML = titlestring;
        div.appendChild(node);
        infowindow.setContent(div);
        infowindow.open(marker.getMap(),marker);
      }

      function loadGateway(){
        $.ajax({
          url: "/api/gateway",
          dataType: "json",
          success: function(jsonData){
            var gateway_names = document.getElementById('gateway_names');
            for(var i=0;i<jsonData.length;i++){
              var gateway_item = jsonData[i]['GATEWAY_NAME'];
              gateway_names.append(new Option(gateway_item));
            }
          }
        })
      }

      function drawChannelRssi(data_point, marker){
        var node_id = parseInt(marker.id);
        var channel_rssi_array = [];
        $.ajax({
          url: "/api/sensor",
          dataType: "json",
          success: function (jsonData) {
            var channel_rssi = jsonData[node_id][data_point]['CHANNEL_INFO'];
            var res = channel_rssi.split('rssi');
            var data_cr = new google.visualization.DataTable();
            data_cr.addColumn('string', 'channel');
            data_cr.addColumn('number', 'Channel RSSI');
            for(var i=1; i<res.length;i++){
              var b = res[i].substring(res[i].indexOf(":")+1,res[i].indexOf(","));
              data_cr.addRow([i.toString(), Number(b)]);
            }
            var options_cr = {
              'legend':'top',
              width: 700,
            };
            var node_cr = document.createElement('div');
            var infoWindow_cr  = new google.maps.InfoWindow();
            var chart_cr = new google.visualization.ColumnChart(node_cr);
            chart_cr.draw(data_cr, options_cr);
            infoWindow_cr.setContent(node_cr);
            infoWindow_cr.open(marker.getMap(),marker);
          }
        }); 
      }

      function getAvgRssi(rssi_string){
        var res = rssi_string.split('rssi');
        var c = 0;
        for(var i=1; i<res.length;i++){
          var b = res[i].substring(res[i].indexOf(":")+1,res[i].indexOf(","));
          c += Number(b);
        }
        return c/res.length;
      }


      function drawChart2(marker){
        curr_marker = marker;
        $.ajax({
          url: "/api/sensor",
          dataType: "json",
          success: function (jsonData) {
            data2 = new google.visualization.DataTable();
            data2.addColumn('date','TIME');
            data2.addColumn('number','APP_PER');
            data2.addColumn('number', 'MAC_PER');
            data2.addColumn('number', 'RSSI');

            data_corr = new google.visualization.DataTable();
            data_corr.addColumn('date', 'TIME');
            data_corr.addColumn('number', 'RSSI/PER')

            var total2 = 0;
            var current2 = 0;
            var predict2_time = [];
            var predict2_per = [];
            var start_date = jsonData[parseInt(marker.id)][0]['DATE'];
            var end_date = jsonData[parseInt(marker.id)][jsonData[parseInt(marker.id)].length-1]['DATE'];
            var start_time = jsonData[parseInt(marker.id)][0]['TIME'];
            var end_time = jsonData[parseInt(marker.id)][jsonData[parseInt(marker.id)].length-1]['TIME'];
            for(var i=0;i<jsonData[parseInt(marker.id)].length;i++){
              var data_time = convertTime4(jsonData[parseInt(marker.id)][i]['DATE'], jsonData[parseInt(marker.id)][i]['TIME']);
              var data_gateway = jsonData[parseInt(marker.id)][i]['GATEWAY_NAME'];
              var data_channel_info = jsonData[parseInt(marker.id)][i]['CHANNEL_INFO'];
              var channel_rssi_avg = getAvgRssi(data_channel_info);
              var data_mac_tx_total = jsonData[parseInt(marker.id)][i]['MAC_TX_TOTAL'];
              var data_mac_tx_fail = jsonData[parseInt(marker.id)][i]['MAC_TX_FAIL'];
              var data_app_per_sent = jsonData[parseInt(marker.id)][i]['APP_PER_SENT'];
              var data_app_per_lost = jsonData[parseInt(marker.id)][i]['APP_PER_LOST'];
              data2.addRow([data_time, conditionalDivision(data_app_per_lost, data_app_per_sent)*100, conditionalDivision(data_mac_tx_fail, data_mac_tx_total)*100, channel_rssi_avg]);
              data_corr.addRow([data_time, conditionalDivision(Math.abs(channel_rssi_avg), conditionalDivision(data_mac_tx_fail, data_mac_tx_total))]);
              predict2_time.push(i);
              current2 = conditionalDivision(data_app_per_lost, data_app_per_sent);
              predict2_per.push(current2);
              total2 += current2;
            }
            var avg2 = total2/jsonData[parseInt(marker.id)].length;
            var predict2 = findLineByLeastSquares(predict2_time, predict2_per)[1][0];
            if(predict2 > 0.05){
              var fault_pbb2 = 1;
            }else if(predict2 > 0.05 && current2 > predict2){
              var fault_pbb2 = 0;
            }else if(current2 < 0.05 && current2 > predict2){
              var fault_pbb2 = 0;
            }else{
              var fault_pbb2 = 1/((0.05-current2)/(predict2-current2));
            }

            var d = new Date();
            d.setHours(d.getHours() - 2);

            options2 = {
              title: 'new chart2',
              displayAnnotations: false,
              allowRedraw: true,
              width: 625,
              scaleType: 'allfixed',
                    // zoomStartTime: d
                  };

                  var node2 = document.createElement('div');
                  node2.style.height = "250px";
                  chart2 = new google.visualization.AnnotatedTimeLine(node2);

                // chart2.setVisibleChartRange();
                // var range = chart2.getVisibleChartRange();
                // if(chart2.getVisibleChartRange()){
                //     var range = chart2.getVisibleChartRange();
                //     chart2.setVisibleChartRange(range['start'], range['end']);
                // }
                // google.visualization.events.addListener(chart2, 'rangechange', function(){
                //     // var range = chart2.getVisibleChartRange();
                //     // var d = new Date();
                //     // d.setHours(d.getHours() - 2);
                //     // chart2.setVisibleChartRange(d, null);
                //     // var range2 = chart2.getVisibleChartRange();
                //     // chart2.setVisibleChartRange(range2['start'], null);
                // });
                chart2.draw(data2, options2);
                // getVisibleChartRange()
                // if(chart2.getVisibleChartRange()){
                //     var range = chart2.getVisibleChartRange();
                //     chart2.setVisibleChartRange(range['start'], range['end']);
                // }

                // chart2.getAction('alertAction');
                
                // setInterval(function(){
                //     chart2.draw(data2, options2);
                // },1000);

                var titlestring2 = '<div id="content">'+
                '<h1 id="firstHeading" class="firstHeading">Node '+parseInt(marker.id)+' | PER vs. RSSI</h1>'+
                '<div id="bodyContent">'+
                '<p><b>Average PER: </b>'+(avg2*100).toFixed(2)+'%'+'</p>'+
                '<p><b>Current PER: </b>'+(current2*100).toFixed(2)+'%'+'</p>'+
                '<p><b>Predicted PER: </b>'+(predict2*100).toFixed(2)+'%'+'</p>'+
                '<p><b>Fault probability: </b>'+(fault_pbb2*100).toFixed(2)+'%'+'</p>'+
                '<p>'+'Start date: <input type="date" id="chart_start_date" />'+'&emsp;Start time: <input type="time" id="chart_start_time" step="1"/>'+'</p>'+
                '<p>'+'End date: <input type="date" id="chart_end_date" />'+'&emsp;End time: <input type="time" id="chart_end_time" step="1"/>'+'</p>'+
                '<p>'+'Metric: <input type="checkbox" value="app_per" id="app_per" checked/>Application Layer PER&emsp;<input type="checkbox" value="mac_per" id="mac_per" checked/>Mac Layer PER&emsp;<input type="checkbox" value="rssi" id="rssi" checked/>RSSI'+'</p>'+
                '</div>'+
                '</div>'+
                '<div id="divleft"><form action="javascript:update();"><input type="submit" value="Update"></form></div>'+
                '<div id="divmid"><form action="javascript:drawCorr();"><input type="submit" value="View correlation"></form></div>'+
                '<div id="divright"><form action="javascript:compare();"><input type="submit" value="Compare"></form>with:<select id="selectcomp"></select></div>';

                var div2 = document.createElement('div');
                div2.innerHTML = titlestring2;
                div2.appendChild(node2);
                infowindow.setContent(div2);

                infowindow.open(marker.getMap(),marker);
                document.getElementById('chart_start_date').valueAsDate = new Date(start_date);
                document.getElementById('chart_end_date').valueAsDate = new Date(end_date);
                document.getElementById('chart_start_time').value = "00:00:00";
                document.getElementById('chart_end_time').value = "23:59:59";

                for(var i=0;i<markers.length;i++){
                  $('#selectcomp').append(new Option(i, i.toString()));
                }

                google.visualization.events.addListener(chart2, 'select', selectHandler);
                function selectHandler(e) {
                  var selected = chart2.getSelection()[0].row;
                  drawChannelRssi(selected, marker);
                }
              }
            });
}

var width = 10;
function updateProgress(){
  var elem = document.getElementById("myBar");   
  if (width >= 100) {
    setTimeout(function(){
      $('#myProgress').remove();
    }, 2000);
  } else {
   width+=(100/(markers.length-4));
   if(width > 100) width = 100;
   elem.style.width = width + '%';
   elem.innerHTML = width.toFixed(2) * 1 + '%'; 
 }
}

function drawTopology(){
  $.ajax({
    url: "/api/topology",
    dataType: "json",
    success: function (jsonData) {
      markers = new Array(jsonData.length);
      for(var i=0; i<jsonData.length;i++){
        if(jsonData[i] != null){
          var newNode = new google.maps.LatLng(jsonData[i]['2'], jsonData[i]['3']);
          var parentid = jsonData[i]['4'];
          if(parentid != null){
            if(getMarker(parentid)){
              addMarker(newNode,i.toString(),"active", parentid.toString());
            }
            else{
              addMarker(newNode,i.toString(),"active", '1');
            }  
          }
          else{
            addMarker(newNode,i.toString(),"active", '1');
          }
        }
      }
      addNetwork(markers,1);
    }
  });
}

function updateGateway(){
  $('#gateway_names').change(function(){
    markers.forEach(function(marker){
      if($('#gateway_names').val() == 'TEST'){
        markerCluster1.clearMarkers();
      }
      else{
        markerCluster1.addMarker(marker);
      }
    });
    links.forEach(function(link){
      if($('#gateway_names').val() == 'TEST'){
        link.setVisible(false);
      }
      else{
        link.setVisible(true);
      }
    });
  });
}

function getSum(total, num) {
  return total + num;
}

function addNetwork(markers,label){
  var app_per_avg_network  = sum_network / markers.length;
  var rssi_avg_network  = sum_network_rssi / markers.length;

  if(label==1){
    var sidebar = $('#demo');
    var sidebar_entry = $('<li/>', {
      'html': '<a href="#demo" class="btn btn-link" data-toggle="collapse">Network '+label
      +'<ul style="padding-left: 5px">Num. Nodes: '+(markers.length - 1 )+'</ul>'
      +'<ul style="padding-left: 5px">Avg. PER: '+app_per_avg_network.toFixed(6)+'</ul>'
      +'<ul style="padding-left: 5px">Avg. RSSI: '+rssi_avg_network.toFixed(6)+'</ul>'
      +'<ul style="padding-left: 5px">Energy status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Stability status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Security status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>',
    }).insertBefore(sidebar);
  }else if(label ==2){
    var sidebar2 = $('#demo2');
    var sidebar_entry2 = $('<li/>', {
      'html': '<a href="#demo2" class="btn btn-link" data-toggle="collapse">Network '+label
      +'<ul style="padding-left: 5px">Num. Nodes: '+(markers2.length - 1 )+'</ul>'
      +'<ul style="padding-left: 5px">Avg. PER: '+app_per_avg_network.toFixed(6)+'</ul>'
      +'<ul style="padding-left: 5px">Avg. RSSI: '+rssi_avg_network.toFixed(6)+'</ul>'
      +'<ul style="padding-left: 5px">Energy status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Stability status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Security status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>',
    }).insertBefore(sidebar2);
  }
}

function conditionalAdd(a, b){
  if(isNaN(b)){
    return a+0;
  }
  else{
    return a+b;
  }
}

var myinterval = null;
function addMarker(location,label,active,parent){
  var node_id = parseInt(label);
  var app_per_sum = 0;
  var rssi_sum = 0;
  var app_per_avg = 0;
  var rssi_avg = 0;
  var array_x = [];
  var array_y = [];
  var array = ['0'];
  var array_time = ['0'];
  var current = ['0'];
  var predict_y = ['0'];
  $.ajax({
    url: "/api/sensor",
    dataType: "json",
    success: function(jsonData){
      for(var i=0;i<jsonData[node_id].length;i++){
        var data_channel_info = jsonData[node_id][i]['CHANNEL_INFO'];
        var avg_rssi = getAvgRssi(data_channel_info);
        var data_app_per_sent = jsonData[node_id][i]['MAC_TX_TOTAL'];
        var data_app_per_lost = jsonData[node_id][i]['MAC_TX_FAIL'];
        array_x.push(i);
        array_y.push(conditionalDivision(data_app_per_lost, data_app_per_sent));
        app_per_sum += conditionalDivision(data_app_per_lost, data_app_per_sent);
        rssi_sum += avg_rssi;
      }
      app_per_avg = app_per_sum / jsonData[node_id].length;
      rssi_avg = rssi_sum / jsonData[node_id].length;
      var current = array_y[array_y.length-1];
      var result = findLineByLeastSquares(array_x, array_y);
      var predict_y = result[1][0];

      var batteryInfo = Math.random() * (0.8 - 0.1) + 0.1;

      var sidebar = $('#demo');
      var sidebar_entry = $('<li/>', {
        'html': '<a href="#infolist">Node '+label
        +'<ul>Parent: '+parent+'</ul>'
        +'<ul>Avg. PER: '+app_per_avg.toFixed(6)+'</ul>'
        +'<ul>Avg. RSSI: '+rssi_avg.toFixed(6)+'</ul>'
        +'<ul>Num. Parent Change: '+(Math.round(Math.random()*5) + 0)+'</ul>'
        +'<ul>Num. Reconnection: '+(Math.round(Math.random()*5) + 0)+'</ul>'
        +'<ul>Battey level: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+batteryInfo+'">'+'</meter>'+'</ul>',
        'click': function() {
          google.maps.event.trigger(marker, 'click');
          $(this).css('color','red');
        },
        'mouseenter': function() {
          $(this).css('color', 'red');
        },
        'mouseleave': function() {
          $(this).css('color', '#999999');
        },
        'focus': function() {
          $(this).css('color', '#FF0000');
        },
        function() {
          $(this).attr("id","newid"+label);
          $(this).addClass('network1');
        }
      }).appendTo(sidebar);
      if(parseFloat(predict_y) > 0.05){
        var fault_pbb = 1;
      }else if(parseFloat(current) > 0.05 && parseFloat(current) > parseFloat(predict_y)){
        var fault_pbb = 0;
      }else if(parseFloat(current) < 0.05 && parseFloat(current) > parseFloat(predict_y)){
        var fault_pbb = 0;
      }else{
        var fault_pbb = 1/((0.05-parseFloat(current))/(parseFloat(predict_y)-parseFloat(current)));
      }

      var app_per_sum_network = 0;
      var rssi_sum_network = 0;
      var num_channel = 0;
      for(var i=0;i<jsonData.length;i++){
        app_per_sum_network = conditionalAdd(app_per_sum_network, app_per_avg);
        rssi_sum_network = conditionalAdd(rssi_sum_network, rssi_avg);
      }
      var app_per_avg_network = app_per_sum_network / jsonData.length;
      var rssi_avg_network = rssi_sum_network / jsonData.length;

      var marker = new google.maps.Marker({
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 15,
          strokeWeight:2,
          fillColor: '#008000',
          fillOpacity: 1.0
        },
        position: location,
        label: label,
        id: label,
        status: active,
        customInfo: array,
        customInfoTime: array_time,
        parentInfo: parent,
        isCritical: 0,
        lossRate: 0,
        batteryInfo: Math.random() * (0.8 - 0.1) + 0.1
      });
      markers[parseInt(label)] = marker;
      markers_location.push(marker);
      markerCluster1.addMarker(marker);

      if(predict_y>0.2){
        marker.icon.fillColor = ' #FFA500 ';
        marker.isCritical = 1;
      }
      if(app_per_avg>0.2){
        marker.icon.fillColor = ' #FF0000 ';
        marker.isCritical = 1;
        marker.lossRate = Math.abs(avg_rssi);
        markMarker(marker);
      }

      marker.addListener('click', function(){
         // clearInterval(myinterval);
                // // $(document).ready(function(){
                //     // drawChart2(this);
                //     myinterval = setInterval(function(){
                //         drawChart2(marker);
                //     },3000);
                // });
                // google.charts.load('current', {'packages':['annotatedtimeline']});
                // google.charts.setOnLoadCallback(function(){
                //     drawChart2(marker);
                //     myinterval = setInterval(function(){
                //         drawChart2(marker);
                //     },5000); // refresh chart per 5 sec.
                // });
                // google.charts.setOnLoadCallback(drawChart(this,avg,current,predict_y,fault_pbb));
            // setInterval(function(){
            //     drawChart(this,avg,current,predict_y,fault_pbb);
            //     alert('draw');
            // }, 1000);
            // drawChart(this,avg,current,predict_y,fault_pbb);
            google.charts.setOnLoadCallback(drawChart2(this));
            var sidebar = document.getElementById("demo");
            var sidebar2 = document.getElementById("demo2");
            var li = document.getElementById("newid"+label);
            if(li != null){
              var color = li.style.backgroundColor;
              li.style.backgroundColor = " #5499c7 ";
              setTimeout(function(){
                li.style.backgroundColor=color;
              }, 2000);
              li.scrollIntoView();
            }
          });
      var link_info = generateRandom();
      var parentMarker = markers_location[parseInt(parent)];
      var path = [
      {lat: marker.getPosition().lat(), lng: marker.getPosition().lng()},
      {lat: parentMarker.getPosition().lat(), lng: parentMarker.getPosition().lng()}
      ];
      var link = new google.maps.Polyline({
        path: path,
        strokeColor: '#000080',
        strokeOpacity: 1.0,
        strokeWeight: 1 + link_info * 100,
        customInfo: link_info
      });
      links.push(link);
      if(link_info > 0.04){
        link.strokeColor = '#800000';
      }
      createInfoWindow(link, "Link traffic : " + link.customInfo);
      link.setMap(map);
      updateProgress();
    }
  })
}
var legend = document.getElementById('legend');
for (var key in icons) {
  var type = icons[key];
  var name = type.name;
  var icon = type.icon;
  var div = document.createElement('div');
  div.innerHTML = '<img src="' + icon + '"> ' + name;
  legend.appendChild(div);
}
var c = document.getElementById("myCanvas");
var ctx = c.getContext("2d");
ctx.fillText("Low",5,12);
ctx.fillText("High",125,12);
ctx.fillText("Noisy zone (PER)",30,35);
var grd = ctx.createLinearGradient(0, 0, 170, 0);
grd.addColorStop(0, "white");
grd.addColorStop(1, " #ff5733");
ctx.fillStyle = grd;
ctx.fillRect(2, 15, 150, 10);

map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(mapreset);
map.controls[google.maps.ControlPosition.LEFT_TOP].push(gateway);
// markRegion();

function shapeMouse(current_shape, index){
  google.maps.event.addListener(current_shape, 'click', function(event) {
    var dup_array = shapes.slice();
    dup_array.splice(index, 1);
    var overlap = 0;
    for(var i=0; i<dup_array.length; i++){
      if(searchArea(event.latLng, dup_array[i])){
        overlap += dup_array[i].lossInfo;
      }
    }
    var areainfo = '<h4>Avg. PER: ' + (parseFloat(current_shape.lossInfo + overlap)*100).toFixed(2)+'%' + '<br />' + 'Affected nodes: ';
    for(var i=current_shape.affected.length-1; i>=0;i--){
      areainfo += (current_shape.affected[i]);
      if(current_shape.affected[i-1]){
        areainfo += ', ';
      }
    }
    areainfo += '</h4>'
    infowindow.setContent(areainfo);
    infowindow.setPosition(event.latLng);
    infowindow.open(map);
    for(var i=0;i<shapes.length;i++){
      shapes[i].setOptions({strokeWeight: 0, fillColor: '#FF5733'});
    }
    current_shape.setOptions({strokeWeight: 5.0, fillColor: 'blue'});
  });
  google.maps.event.addListener(map, 'click', function() {
    infowindow.close();
    clearInterval(myinterval);
    current_shape.setOptions({strokeWeight: 0, fillColor: '#FF5733'});
  });

}
function createAreaInfo(){
  for(var i=0;i<shapes.length;i++){
    var current_shape = shapes[i];
    shapeMouse(current_shape, i);
  }
}
createAreaInfo();
}

  // google.load('visualization', '1.0', {'packages':['corechart']});
  google.charts.load('current', {'packages':['annotatedtimeline']});

  var elmnt = document.getElementById("sidebar-wrapper");
  elmnt.onscroll = function() {scrollFunction()};

  function scrollFunction() {
    if (elmnt.scrollTop > 20) {
      document.getElementById("myBtn").style.display = "block";
    } else {
      document.getElementById("myBtn").style.display = "none";
    }
  }

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
  elmnt.scrollTop = 0;
}

var timeleft = 5;
var downloadTimer = setInterval(function(){
  timeleft--;
  if(document.getElementById("countdowntimer")){
    document.getElementById("countdowntimer").textContent = timeleft;}
    if(timeleft <= 0)
      clearInterval(downloadTimer);
  },1000);

  // if(!window.location.hash){
  //   var overlay = jQuery('<div id="overlay"><div id="text">Gateways: <form action="javascript:confirm();"><input type="checkbox">'+
  //    data_gateway_test[0]['GATEWAY_NAME']+
  //    '<br><input type="checkbox">'+
  //    data_gateway_test[1]['GATEWAY_NAME']+
  //    '<br><input type="checkbox">'+
  //    data_gateway_test[2]['GATEWAY_NAME']+
  //    '<br><input type="checkbox">'+
  //    data_gateway_test[3]['GATEWAY_NAME']+
  //    '<br><input id="confirm" type="submit" value="Confirm"></form>'+
  //     // '<span id="countdowntimer">5 </span> seconds'+
  //     '</div></div>');
  //   overlay.appendTo(document.body)
  // }

// window.onload = setTimeout(function(){ 
//     if(!window.location.hash) {
//         window.location = window.location + '#loaded';
//         window.location.reload();
//     }
// }, 5000);

  // alert("Loading...");

</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpPgcU1vPIge5zzD50cfVkL7DVpIVKac0&callback=initMap">
</script>



</body>

</html>
