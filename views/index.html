<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IoT</title>

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">

  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Simple markers</title>
  <style>
  #map {
    height: 100%;
  }
  #legend {
    font-family: Arial, sans-serif;
    background: #fff;
    padding: 10px;
    margin: 10px;
    border: 3px solid #000;
  }
  #legend h3 {
    margin-top: 0;
  }
  #legend img {
    vertical-align: middle;
  }

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  #map,
  #wrapper,
  #page-content-wrapper {
    height: 100%;
    width: 100%;
  }
  .container-fluid,
  .row,
  .col-lg-12 {
    height: 100%;
    width: 100%;
  }
}

.box-shadow-menu {
  position: relative;
  padding-left: 1.25em;
}
.box-shadow-menu:before {
  content: "";
  position: absolute;
  left: 0;
  top: 0.25em;
  width: 1em;
  height: 0.15em;
  background: black;
  box-shadow: 0 0.25em 0 0 black, 0 0.5em 0 0 black;
}

.gradient-menu {
  padding-left: 1.25em;
  position: relative;
}
.gradient-menu:before {
  content: "";
  position: absolute;
  left: 0;
  top: 0.21em;
  bottom: 0.21em;
  width: 1em;
  background: linear-gradient(to bottom, black, black 20%, white 20%, white 40%, black 40%, black 60%, white 60%, white 80%, black 80%, black 100%);
}

.nav-tabs>li {
  float: none;
}
.nav-tabs {
  border-bottom: 0;
}
.nav-tabs>li.active>a,
.nav-tabs>li.active>a:focus,
.nav-tabs>li.active>a:hover {
  margin: 0;
  border-radius: 0;
}
#wrapper {
  padding-left: 0;
  -webkit-transition: all 0.5s ease;
  -moz-transition: all 0.5s ease;
  -o-transition: all 0.5s ease;
  transition: all 0.5s ease;
}
#wrapper.toggled {
  padding-left: 250px;
}
#sidebar-wrapper {
  z-index: 1000;
  position: fixed;
  left: 250px;
  width: 0;
  height: 100%;
  margin-left: -250px;
  overflow-y: auto;
  background: #a9cce3;
  -webkit-transition: all 0.5s ease;
  -moz-transition: all 0.5s ease;
  -o-transition: all 0.5s ease;
  transition: all 0.5s ease;
}
#wrapper.toggled #sidebar-wrapper {
  width: 250px;
}
#page-content-wrapper {
  width: 100%;
  position: absolute;
  padding: 15px;
}
#wrapper.toggled #page-content-wrapper {
  position: absolute;
  margin-right: -250px;
}

.sidebar-nav {
  position: absolute;
  top: 0;
  width: 250px;
  margin: 0;
  padding: 0;
  list-style: none;
}
.sidebar-nav li {
  text-indent: 20px;
  line-height: 40px;
}
.sidebar-nav li a {
  display: block;
  text-decoration: none;
  color: #000000;
}
.sidebar-nav li a:hover {
  text-decoration: none;
  color: #000080;
  background: rgba(255, 255, 255, 0.2);
}
.sidebar-nav li a:active,
.sidebar-nav li a:focus {
  text-decoration: none;
}
.sidebar-nav > .sidebar-brand {
  height: 65px;
  font-size: 18px;
  line-height: 60px;
}
.sidebar-nav > .sidebar-brand a {
  color: #999999;
}
.sidebar-nav > .sidebar-brand a:hover {
  color: #fff;
  background: none;
}
@media(min-width:768px) {
  #wrapper {
    padding-left: 250px;
  }
  #wrapper.toggled {
    padding-left: 0;
  }
  #sidebar-wrapper {
    width: 250px;
  }
  #wrapper.toggled #sidebar-wrapper {
    width: 0;
  }
  #page-content-wrapper {
    padding: 20px;
    position: relative;
  }
  #wrapper.toggled #page-content-wrapper {
    position: relative;
    margin-right: 0;
  }
}
ul {
  text-align: left;
}
.ulleft {
  display: inline;
  float: left;
}
.ulright {
  display: inline;
  float: right;
}
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #000;
  filter:alpha(opacity=50);
  -moz-opacity:0.5;
  -khtml-opacity: 0.5;
  opacity: 0.8;
  z-index: 10000;
}
#confirm{
  color: black;
}
#text{
  position: absolute;
  top: 50%;
  left: 50%;
  font-size: 50px;
  color: white;
  transform: translate(-50%,-50%);
  -ms-transform: translate(-50%,-50%);
}
#myBtn {
  display: none;
  position: fixed;
  bottom: 5px;
  left: 250px;
  z-index: 99;
  border: none;
  outline: none;
  background-color: black;
  color: white;
  cursor: pointer;
  padding: 5px;
  border-radius: 50px;
  font-size: 40px;
  height: 50px;
  width: 50px;
}

#myBtn:hover {
  background-color: #555;
}

#mapresetbtn {
  bottom: 5px;
  left: 250px;
  z-index: 99;
  border: none;
  outline: none;
  background-color: black;
  color: white;
  cursor: pointer;
  padding: 5px;
  border-radius: 50px;
  font-size: 40px;
  height: 50px;
  width: 50px;
  margin: 10px;
}
#mapresetbtn:hover{
  background-color: #555;
}

hr {
  display: block;
  border: 2px solid;
  border-top: 1px solid #ccc;
  margin: 1em 0;
  padding: 0; 
  border-color: #000000;
}
#container {
  width: 100%;
  height: 100%;
  overflow: hidden;
}
.sidenav {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  right: 0;
  background-color: #a9cce3;
  overflow-x: hidden;
  transition: 0.5s;
}
.sidenav a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.sidenav a:hover, .offcanvas a:focus{
  color: #f1f1f1;
}


.sidenav .closebtn {
  top: 0;
  right: 25px;
  font-size: 46px;
}
@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
#toolkit {
  display: inline-block;
  padding-left: 50px;
}
#close{
  float: right;
}
#divleft{
  display: inline-block;
}
#divmid{
  display: inline-block;
  padding-left: 10px;
}
#divright{
  display: inline-block;
  padding-left: 10px;
}
#divcritical{
  display: inline-block;
  padding-left: 10px;
}
#myProgress {
  width: 100%;
  background-color: #ddd; 
}
#myBar {
  width: 0%;
  height: 30px;
  background-color: #4CAF50;
  text-align: center;
  line-height: 30px;
  color: white; 
}
.floated {
  float:left;
  margin-right:5px;
}
.onoffswitch {
  position: relative; width: 90px;
  -webkit-user-select:none; -moz-user-select:none; -ms-user-select: none;
}
.onoffswitch-checkbox {
  display: none;
}
.onoffswitch-label {
  display: block; overflow: hidden; cursor: pointer;
  border: 2px solid #999999; border-radius: 20px;
}
.onoffswitch-inner {
  display: block; width: 200%; margin-left: -100%;
  transition: margin 0.3s ease-in 0s;
}
.onoffswitch-inner:before, .onoffswitch-inner:after {
  display: block; float: left; width: 50%; height: 30px; padding: 0; line-height: 30px;
  font-size: 14px; color: white; font-family: Trebuchet, Arial, sans-serif; font-weight: bold;
  box-sizing: border-box;
}
.onoffswitch-inner:before {
  content: "ON";
  padding-left: 10px;
  background-color: #34A7C1; color: #FFFFFF;
}
.onoffswitch-inner:after {
  content: "OFF";
  padding-right: 10px;
  background-color: #EEEEEE; color: #999999;
  text-align: right;
}
.onoffswitch-switch {
  display: block; width: 18px; margin: 6px;
  background: #FFFFFF;
  position: absolute; top: 0; bottom: 0;
  right: 56px;
  border: 2px solid #999999; border-radius: 20px;
  transition: all 0.3s ease-in 0s; 
}
.onoffswitch-checkbox:checked + .onoffswitch-label .onoffswitch-inner {
  margin-left: 0;
}
.onoffswitch-checkbox:checked + .onoffswitch-label .onoffswitch-switch {
  right: 0px; 
}
.button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding: 16px 32px;
  text-align: center;class="button button1"
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  -webkit-transition-duration: 0.4s;
  transition-duration: 0.4s;
  cursor: pointer;
}
.buttonblue {
  background-color: white; 
  color: black; 
  border: 2px solid #008CBA;
}

.buttonblue:hover {
  background-color: #008CBA;
  color: white;
}

.toggle {
  -webkit-appearance: none;
  appearance: none;
  width: 62px;
  height: 32px;
  display: inline-block;
  position: relative;
  border-radius: 50px;
  overflow: hidden;
  outline: none;
  border: none;
  cursor: pointer;
  background-color: #707070;
  transition: background-color ease 0.3s;
}

.toggle:before {
  content: "on off";
  display: block;
  position: absolute;
  z-index: 2;
  width: 28px;
  height: 28px;
  background: #fff;
  left: 2px;
  top: 2px;
  border-radius: 50%;
  font: 10px/28px Helvetica;
  text-transform: uppercase;
  font-weight: bold;
  text-indent: -22px;
  word-spacing: 37px;
  color: #fff;
  text-shadow: -1px -1px rgba(0,0,0,0.15);
  white-space: nowrap;
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  transition: all cubic-bezier(0.3, 1.5, 0.7, 1) 0.3s;
}

.toggle:checked {
  background-color: #4CD964;
}

.toggle:checked:before {
  left: 32px;
}

</style>


</head>

<body>
  <div class="container">
  </div>
  <div id="myProgress">
    <div id="myBar">0%</div>
  </div>
  <div id="wrapper" class="toggled">
    <div id="page-content-wrapper">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-12">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="antixss.js" type="text/javascript"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <script src="//cdn.jsdelivr.net/webshim/1.14.5/polyfiller.js"></script>

  <script type="text/javascript">
  /* convert timestamp to standard time format */
  function convertTime4(date_string, time_string){
    var date_temp_array = date_string.split('-');
    var time_temp_array = time_string.split(':');
    return new Date(date_temp_array[0], date_temp_array[1]-1, date_temp_array[2], time_temp_array[0], time_temp_array[1], time_temp_array[2], 0);
  }

  /* division if divisor=0 */
  function conditionalDivision(a,b){
    if(b==0){
      return 0;
    }else if(a>b){
      return 1;
    }else{
      return a/b;
    }
  }

  /* avg rssi value for drawing chart */
  function getAvgRssi(rssi_string){
    var res = rssi_string.split('rssi');
    var c = 0;
    for(var i=1; i<res.length;i++){
      var b = res[i].substring(res[i].indexOf(":")+1,res[i].indexOf(","));
      c += Number(b);
    }
    return c/res.length;
  }

  var chart2; 
  var data2;
  var options2;
  var curr_marker;
  var data_corr;

  /* draw chart for each node */
  function drawChart3(marker){
    $.ajax({
      url: "/api/sensor",
      dataType: "json",
      success: function (jsonData) {
        for(var i=0;i<jsonData[parseInt(marker.id)].length;i++){
          var data_time = convertTime4(jsonData[parseInt(marker.id)][i]['DATE'], jsonData[parseInt(marker.id)][i]['TIME']);
          var data_gateway = jsonData[parseInt(marker.id)][i]['GATEWAY_NAME'];
          var data_channel_info = jsonData[parseInt(marker.id)][i]['CHANNEL_INFO'];
          var channel_rssi_avg = getAvgRssi(data_channel_info);
          var data_mac_tx_total = jsonData[parseInt(marker.id)][i]['MAC_TX_TOTAL'];
          var data_mac_tx_fail = jsonData[parseInt(marker.id)][i]['MAC_TX_FAIL'];
          var data_app_per_sent = jsonData[parseInt(marker.id)][i]['APP_PER_SENT'];
          var data_app_per_lost = jsonData[parseInt(marker.id)][i]['APP_PER_LOST'];
          data2.addRow([data_time, conditionalDivision(data_app_per_lost, data_app_per_sent)*100, conditionalDivision(data_mac_tx_fail, data_mac_tx_total)*100, channel_rssi_avg]);
        }
        options2 = {
          title: 'new chart2',
          displayAnnotations: false,
          allowRedraw: true,
          width: 625,
          scaleType: 'allfixed',
        };
        chart2.draw(data2, options2);
        chart2.setVisibleChartRange(null, null);
      }
    });
}


/* update chart by time selection */
function update(){
  chart2.hideDataColumns(0);
  chart2.hideDataColumns(1);
  chart2.hideDataColumns(2);
  var chart_start_date = new Date($('#chart_start_date').val().toString());
  var chart_end_date = new Date($('#chart_end_date').val().toString());
  var select_start = chart_start_date.getTime();
  var select_end = chart_end_date.getTime();  
  var id = curr_marker.id;
  $.ajax({
    method: "POST",
    url: "/api/sensor",
    data: {startTime:select_start,endTime:select_end,markerId:id},
    success: function(data){
      drawChart3(curr_marker);
    }
  })         
  if(document.getElementById('app_per').checked){
    chart2.showDataColumns(0);
  }
  if(document.getElementById('mac_per').checked){
    chart2.showDataColumns(1);
  }
  if(document.getElementById('rssi').checked){
    chart2.showDataColumns(2);
  }
  chart2.draw(data2, options2);
  if(!isNaN(chart_start_date) && !isNaN(chart_end_date)){
    chart2.setVisibleChartRange(chart_start_date, chart_end_date);
  } 
}

/* draw correlation chart */
function drawCorr(){
  var options_corr = {};
  var node_corr = document.createElement('div');
  var infoWindow_corr  = new google.maps.InfoWindow();
  var chart_corr = new google.visualization.ScatterChart(node_corr);
  chart_corr.draw(data_corr, options_corr);
  infoWindow_corr.setContent(node_corr);
  infoWindow_corr.open(curr_marker.getMap(),marker);
}

/* draw comparison chart */
function compare(){
  var comp_id1 = parseInt(curr_marker.id);
  var comp_id2 = $('#selectcomp').val();
  $.ajax({
    url: "/api/sensor",
    dataType: "json",
    success: function(jsonData){
      var data_comp = new google.visualization.DataTable();
      data_comp.addColumn('date', 'TIME')
      data_comp.addColumn('number', 'MAC_PER'+comp_id1);
      data_comp.addColumn('number', 'MAC_PER'+comp_id2);
      for(var i=0; i<jsonData[comp_id1].length;i++){
        var data_comp_time = convertTime4(jsonData[comp_id1][i]['DATE'], jsonData[comp_id1][i]['TIME']);
        var data_comp_mac_tx_total1 = jsonData[comp_id1][i]['MAC_TX_TOTAL'];
        var data_comp_mac_tx_fail1 = jsonData[comp_id1][i]['MAC_TX_FAIL'];
        var data_comp_mac_tx_total2 = jsonData[comp_id2][i]['MAC_TX_TOTAL'];
        var data_comp_mac_tx_fail2 = jsonData[comp_id2][i]['MAC_TX_FAIL'];
        data_comp.addRow([data_comp_time, conditionalDivision(data_comp_mac_tx_fail1, data_comp_mac_tx_total1)*100, conditionalDivision(data_comp_mac_tx_fail2, data_comp_mac_tx_total2)*100]);
      }
      var options_comp = {};
      var node_comp = document.createElement('div');
      var infoWindow_comp = new google.maps.InfoWindow();
      var chart_comp = new google.visualization.AnnotatedTimeLine(node_comp);
      chart_comp.draw(data_comp, options_comp);
      infoWindow_comp.setContent(node_comp);
      infoWindow_comp.open(curr_marker.getMap(), marker);
    }
  })
}

/* critical time indicator */
var critical_time = [];
var critical_time_index;
function nextcritical(){
  if(critical_time){
    var current_critical_time = critical_time[critical_time_index];
    if(critical_time_index == 0){
      critical_time_index = critical_time.length-1;
    }else{
      critical_time_index --;
    }
    chart2.setVisibleChartRange(current_critical_time, null);
    $('#criticaltime').val(current_critical_time);
  }
}


/* chart reset */
function chartReset(){
  chart2.setVisibleChartRange(null, null);
  $('#criticaltime').val('');
}

var array_time = [];
var array_time_all = [];
</script>

<script>
var data_gateway_test = [];
var sensorComplete = false;
var data_test = [];
var data_topo_test = [];
</script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
<script type="text/javascript">
var map;
/* reset map zooming */
function mapReset(){
  map.setZoom(5);
  map.setCenter(new google.maps.LatLng(41.850033, -87.6500523));
}

/* fetch network stat data: latency */
var network_stat_data_plus = [];
function getStatPlus(){
  $.ajax({
    url: "/api/networkstatplus",
    dataType: "json",
    success: function(jsonData){
      for(var i=0;i<jsonData.length;i++){
        if(jsonData[i]){
          network_stat_data_plus[i] = jsonData[i];
        }
      }
    }
  })
}

google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(drawStat);

/* fetch network stat data: latency, app_per, mac_per */
function drawStat(){
  getStatPlus();
  $.ajax({
    url: "/api/networkstat",
    dataType: "json",
    success: function(jsonData){
      var network_stat_data = new google.visualization.DataTable();
      network_stat_data.addColumn('number', 'SENSOR ID');
      network_stat_data.addColumn('number', 'LATENCY');
      network_stat_data.addColumn('number', 'MAC PER');
      network_stat_data.addColumn('number', 'APP PER');
      network_stat_data.addColumn('string', ' ');
      for(var i=0; i<jsonData.length; i++){
        if(jsonData[i] && network_stat_data_plus[i]){
          network_stat_data.addRow([jsonData[i]['SENSOR_ID'], jsonData[i]['2'], conditionalDivision(network_stat_data_plus[i]['3'], network_stat_data_plus[i]['2']), conditionalDivision(network_stat_data_plus[i]['5'], network_stat_data_plus[i]['4']), ' ']);
        }
      }
      var network_stat_table = new google.visualization.Table(document.getElementById('networkstat'));
      var network_stat_options = {
        "title": "Network Statistics",
        width: "100%",
        height: "100%"
      };
      network_stat_table.draw(network_stat_data, network_stat_options);
      google.visualization.events.addListener(network_stat_table, 'select', selectHandler);
      function selectHandler(){
        var selection = network_stat_table.getSelection();
        var item = selection[0].row;
        var sid = network_stat_data.getValue(item, 0);
        google.maps.event.trigger(markers[sid], 'click');
      }
    }
  })
$('#networkstatblock').hide();
}

</script>
<div id="gateway" style="font-size:20px; background-color: lightblue; margin-left: 10px;">
 Gateway:
 <select id="gateway_names"></select>
</div>
<div id="networkstatblockcontrol"><label style="font-size:20px;"><input id="statcontrolswitch" class="toggle" type="checkbox" />Network Statistics</label></div>
<div id="noizy">
  <div style="font-size:20px; background-color: lightsalmon;">Noizy zone</div>
  <div class="onoffswitch">
    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch">
    <label class="onoffswitch-label" for="myonoffswitch">
      <span class="onoffswitch-inner"></span>
      <span class="onoffswitch-switch"></span>
    </label>
  </div>
</div>

<div id="networkstatblock" style="padding:10px; height:80%; background-color: lightblue; margin-left:10px">
  <div id="networkstat" style="padding-left:10px; height:96%"></div>
</div>

<div id="mapreset">
  <button id="mapresetbtn" type="button" onclick="mapReset()">&#8634;</button>
</div>
<div id="legend"><h3>Status</h3>
  <canvas id="myCanvas" width="150" height="40">
  </div>


  <script>
  var marker;
  var markers = [];
  var links = [];
  var markers_location = [];
  var markers2 = [];
  var sum_network_per = 0;
  var sum_network_rssi = 0;
  var zoomChange = null;
  var marker_critical = [];

  /* map initialization */
  function initMap() {
    var myWrapper = $("#wrapper");
    $("#menu-toggle").click(function(e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
      if($("#wrapper").hasClass("toggled")){
        document.getElementById("myBtn").style.display = "none";
      }
      myWrapper.one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function(e) {
        google.maps.event.trigger(map, 'resize');
      });
    });

    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 5,
      center: new google.maps.LatLng(41.850033, -87.6500523)
    });

    google.maps.event.addListener(map, 'click', function() {
      infowindow.close();
      clearInterval(myinterval);
    });

    var iconBase = 'http://labs.google.com/ridefinder/images/';

    var icons = {
      active: {
        name: 'Active',
        icon: iconBase + 'mm_20_green.png'
      },
      warning: {
        name: 'Warning',
        icon: iconBase + 'mm_20_orange.png'
      },
      critical: {
        name: 'Critical',
        icon: iconBase + 'mm_20_red.png'
      }
    };

    var contentString = '';

    var infowindow = new google.maps.InfoWindow({
      content: contentString,
    });

    var markerCluster1 = new MarkerClusterer(map, markers_location,
    {
      maxZoom: 5,
      imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
      ignoreHidden: true
    });
    loadGateway();
    drawTopology("TEST1");
    drawLink("TEST1");

    addNetwork(markers2,2);

    updateGateway();
    controlStat();
    drawCritical();

    /* PER value prediction */
    function findLineByLeastSquares(values_x, values_y) {
      var sum_x = 0;
      var sum_y = 0;
      var sum_xy = 0;
      var sum_xx = 0;
      var count = 0;
      var x = 0;
      var y = 0;
      var values_length = values_x != null ? values_x.length : 0;
      if (values_length === 0) {
        return [ [], [] ];
      }
      for (var v = 0; v < values_length; v++) {
        x = values_x[v];
        y = values_y[v];
        sum_x += x;
        sum_y += y;
        sum_xx += x*x;
        sum_xy += x*y;
        count++;
      }
      var m = (count*sum_xy - sum_x*sum_y) / (count*sum_xx - sum_x*sum_x);
      var b = (sum_y/count) - (m*sum_x)/count;
      var result_values_x = [];
      var result_values_y = [];

      for (var v = 0; v < values_length; v++) {
        x = values_x[v];
        y = x * m + b;
        result_values_x.push(x);
        result_values_y.push(y);
      }
      return [result_values_x, result_values_y];
    }

    /* get marker custom info: data */
    function getCustomInfo(marker){
      return marker.customInfo;
    }

    /* get marker custom info: time */
    function getCustomInfoTime(marker){
      return marker.customInfoTime;
    }

    /* get marker id */
    function getMarker(id){
      return markers[parseInt(id)];
    }

    /* generate a random number */
    function generateRandom(){
      return Math.random() * (0.06 - 0.00) + 0.00;
    }

    /* calculate the mid point between two markers */
    function calcMid(marker){
      var parent_id = marker.parentInfo;
      var parent_marker = getMarker(parent_id);
      if(parent_marker){
        var x = (marker.getPosition().lat() + parent_marker.getPosition().lat())/2;
        var y = (marker.getPosition().lng() + parent_marker.getPosition().lng())/2;
        var midpoint = new google.maps.LatLng(x, y);
        return midpoint;
      }
    }

    /* calculate the distance between two markers */
    function calcDistance(marker1,marker2){
      var x = marker1.getPosition().lat() - marker2.getPosition().lat();
      var y = marker1.getPosition().lng() - marker2.getPosition().lng();
      var distance = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
      return distance;
    }

    /* get the parent of current marker */
    function getParent(marker){
      var parent_id = marker.parentInfo;
      var parent_marker = getMarker(parent_id);
      return parent_marker;
    }

    /* check if multiple critical areas are overlapped */
    function searchArea(position, area){
      if(area.shapeType == 1){
        var center = area.getCenter();
        var radius = area.getRadius();
        if(google.maps.geometry.spherical.computeDistanceBetween(position, center) < radius){
          return true;
        }else{
          return false;
        }
      }else if(area.shapeType == 0){
        return google.maps.geometry.poly.containsLocation(position, area);
      }else{
        return false;
      }
    }

    /* create custom infowindow */
    var shapes = [];
    function createInfoWindow(poly, content) {  
      google.maps.event.addListener(poly, 'click', function(event) {
        infowindow.setContent(content);
        infowindow.setPosition(event.latLng);
        infowindow.open(map);
      });
    }

    /* fetch gateway names */
    function loadGateway(){
      $.ajax({
        url: "/api/gateway",
        dataType: "json",
        success: function(jsonData){
          var gateway_names = document.getElementById('gateway_names');
          for(var i=0;i<jsonData.length;i++){
            var gateway_item = jsonData[i]['GATEWAY_NAME'];
            gateway_names.append(new Option(gateway_item));
          }
        }
      })
    }

    /* draw chart for channeled rssi values */
    function drawChannelRssi(data_point, marker){
      var node_id = parseInt(marker.id);
      var channel_rssi_array = [];
      $.ajax({
        url: "/api/sensor",
        dataType: "json",
        success: function (jsonData) {
          var channel_rssi = jsonData[node_id][data_point]['CHANNEL_INFO'];
          var res = channel_rssi.split('rssi');
          var data_cr = new google.visualization.DataTable();
          data_cr.addColumn('string', 'channel');
          data_cr.addColumn('number', 'Channel RSSI');
          for(var i=1; i<res.length;i++){
            var b = res[i].substring(res[i].indexOf(":")+1,res[i].indexOf(","));
            data_cr.addRow([i.toString(), Number(b)]);
          }
          var options_cr = {
            'legend':'top',
            width: 700,
          };
          var node_cr = document.createElement('div');
          var infoWindow_cr  = new google.maps.InfoWindow();
          var chart_cr = new google.visualization.ColumnChart(node_cr);
          chart_cr.draw(data_cr, options_cr);
          infoWindow_cr.setContent(node_cr);
          infoWindow_cr.open(marker.getMap(),marker);
        }
      });
}

/* calculate avg rssi value 16 channels */
function getAvgRssi(rssi_string){
  var res = rssi_string.split('rssi');
  var c = 0;
  var num_of_channel = 0;
  for(var i=1; i<res.length;i++){
    var b = res[i].substring(res[i].indexOf(":")+1,res[i].indexOf(","));
    if(Number(b) != 0){
      c += Number(b);
      num_of_channel ++;
    }
  }
  return c/num_of_channel;
}

/* draw annotated timeline chart on each marker */
function drawChart2(marker){
  curr_marker = marker;
  $.ajax({
    url: "/api/sensor",
    dataType: "json",
    success: function (jsonData) {
      data2 = new google.visualization.DataTable();
      data2.addColumn('date','TIME');
      data2.addColumn('number','APP_PER');
      data2.addColumn('number', 'MAC_PER');
      data2.addColumn('number', 'RSSI');

      data_corr = new google.visualization.DataTable();
      data_corr.addColumn('date', 'TIME');
      data_corr.addColumn('number', 'RSSI/PER')

      var total2 = 0;
      var current2 = 0;
      var predict2_time = [];
      var predict2_per = [];
      var start_date_string = jsonData[parseInt(marker.id)][0]['DATE'];
      var end_date_string = jsonData[parseInt(marker.id)][jsonData[parseInt(marker.id)].length-1]['DATE'];
      var start_time = jsonData[parseInt(marker.id)][0]['TIME'];
      var end_time = jsonData[parseInt(marker.id)][jsonData[parseInt(marker.id)].length-1]['TIME'];
      critical_time = [];
      for(var i=0;i<jsonData[parseInt(marker.id)].length;i++){
        var data_time = convertTime4(jsonData[parseInt(marker.id)][i]['DATE'], jsonData[parseInt(marker.id)][i]['TIME']);
        var data_gateway = jsonData[parseInt(marker.id)][i]['GATEWAY_NAME'];
        var data_channel_info = jsonData[parseInt(marker.id)][i]['CHANNEL_INFO'];
        var channel_rssi_avg = getAvgRssi(data_channel_info);
        var data_mac_tx_total = jsonData[parseInt(marker.id)][i]['MAC_TX_TOTAL'];
        var data_mac_tx_fail = jsonData[parseInt(marker.id)][i]['MAC_TX_FAIL'];
        var data_app_per_sent = jsonData[parseInt(marker.id)][i]['APP_PER_SENT'];
        var data_app_per_lost = jsonData[parseInt(marker.id)][i]['APP_PER_LOST'];
        if(conditionalDivision(data_mac_tx_fail, data_mac_tx_total) > 0.2){
          critical_time.push(data_time);
        }
        critical_time_index = critical_time.length-1;
        data2.addRow([data_time, conditionalDivision(data_app_per_lost, data_app_per_sent)*100, conditionalDivision(data_mac_tx_fail, data_mac_tx_total)*100, channel_rssi_avg]);
        data_corr.addRow([data_time, conditionalDivision(Math.abs(channel_rssi_avg), conditionalDivision(data_mac_tx_fail, data_mac_tx_total))]);
        predict2_time.push(i);
        current2 = conditionalDivision(data_app_per_lost, data_app_per_sent);
        predict2_per.push(current2);
        total2 += current2;
      }
      var avg2 = total2/jsonData[parseInt(marker.id)].length;
      var predict2 = findLineByLeastSquares(predict2_time, predict2_per)[1][0];
      if(predict2 > 0.05){
        var fault_pbb2 = 1;
      }else if(predict2 > 0.05 && current2 > predict2){
        var fault_pbb2 = 0;
      }else if(current2 < 0.05 && current2 > predict2){
        var fault_pbb2 = 0;
      }else{
        var fault_pbb2 = 1/((0.05-current2)/(predict2-current2));
      }

      var d = new Date();
      d.setHours(d.getHours() - 2);

      options2 = {
        title: 'new chart2',
        displayAnnotations: false,
        allowRedraw: true,
        width: 625,
        scaleType: 'allfixed',
      };

      var node2 = document.createElement('div');
      node2.style.height = "250px";
      chart2 = new google.visualization.AnnotatedTimeLine(node2);

      chart2.draw(data2, options2);


      var titlestring2 = '<div id="content">'+
      '<h1 id="firstHeading" class="firstHeading">Node '+parseInt(marker.id)+' | PER vs. RSSI</h1>'+
      '<div id="bodyContent">'+
      '<p><b>Average PER: </b>'+(avg2*100).toFixed(2)+'%'+'</p>'+
      '<p><b>Current PER: </b>'+(current2*100).toFixed(2)+'%'+'</p>'+
      '<p><b>Predicted PER: </b>'+(predict2*100).toFixed(2)+'%'+'</p>'+
      '<p><b>Fault probability: </b>'+(fault_pbb2*100).toFixed(2)+'%'+'</p>'+
      '<p>'+'Start date: <input type="date" id="chart_start_date" />'+
      '&emsp;End date: <input type="date" id="chart_end_date" />'+
      '</p>'+
      '<p>'+'Metric: <input type="checkbox" value="app_per" id="app_per" checked/>Application Layer PER&emsp;<input type="checkbox" value="mac_per" id="mac_per" checked/>Mac Layer PER&emsp;<input type="checkbox" value="rssi" id="rssi" checked/>RSSI'+'</p>'+
      '</div>'+
      '</div>'+
      '<div id="divleft" class="borderdiv"><form action="javascript:update();"><input type="submit" value="Update"></form></div> |'+
      '<div id="divmid" class="borderdiv"><form action="javascript:drawCorr();"><input type="submit" value="View correlation"></form></div> |'+
      '<div id="divright" class="borderdiv"><form action="javascript:compare();"><input type="submit" value="Compare"></form>with:<select id="selectcomp"></select></div> |'+
      '<div id="divcritical" class="borderdiv">Critical time:<input type="text" id="criticaltime"><form action="javascript:nextcritical();"><input type="submit" class="floated" value="Next"><input type="button" class="floated" value="Reset" onclick="javascript:chartReset();"></div>';

      var div2 = document.createElement('div');
      div2.innerHTML = titlestring2;
      div2.appendChild(node2);
      infowindow.setContent(div2);

      infowindow.open(marker.getMap(),marker);
      start_date = new Date(start_date_string);
      start_date.setDate(start_date.getDate()+1);
      end_date = new Date(end_date_string);
      end_date.setDate(end_date.getDate()-2);
      document.getElementById('chart_start_date').valueAsDate = end_date;
      document.getElementById('chart_end_date').valueAsDate = start_date;

      for(var i=0;i<markers.length;i++){
        $('#selectcomp').append(new Option(i, i.toString()));
      }

      google.visualization.events.addListener(chart2, 'select', selectHandler);
      function selectHandler(e) {
        var selected = chart2.getSelection()[0].row;
        drawChannelRssi(selected, marker);
      }
    }
  });
}

/* update progress bar on page initialization */
var width = 10;
function updateProgress(){
  var elem = document.getElementById("myBar");   
  if (width >= 100) {
    setTimeout(function(){
      $('#myProgress').remove();
    }, 2000);
  } else {
   width+=(100/(markers.length-4));
   if(width > 100) width = 100;
   elem.style.width = width + '%';
   elem.innerHTML = width.toFixed(2) * 1 + '%'; 
 }
}

/* draw topology on page initialization */
function drawTopology(gateway){
  $.ajax({
    url: "/api/topology",
    dataType: "json",
    success: function (jsonData) {
      markers = new Array(jsonData.length);
      for(var i=0; i<jsonData.length;i++){
        if(jsonData[i] != null){
          var newNode = new google.maps.LatLng(jsonData[i]['GPS_LAT'], jsonData[i]['GPS_LONG']);
          var parentid = jsonData[i]['PARENT'];
          var gateway_name = jsonData[i]['GATEWAY_NAME'];
          var sensor_id = jsonData[i]['SENSOR_ID'];
          if(gateway){
            if(gateway == gateway_name){
              if(parentid != null){
                addMarker(newNode,sensor_id.toString(),"active", parentid.toString(), gateway_name);
              }else{
                var marker = new google.maps.Marker({
                  map: map,
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    strokeWeight:2,
                    fillColor: '#493D26',
                    fillOpacity: 1.0
                  },
                  position: newNode,
                  label: {
                    text: sensor_id.toString(),
                    color: 'white'
                  },
                  id: i,
                  gateway_id: gateway_name
                });
                markers[i] = marker;
                markers_location.push(marker);
                markerCluster1.addMarker(marker);
              }
            }
          }
          else{
            if(parentid != null){
              addMarker(newNode,sensor_id.toString(),"active", parentid.toString(), gateway_name);
            }else{
              var marker = new google.maps.Marker({
                map: map,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 15,
                  strokeWeight:2,
                  fillColor: '#493D26',
                  fillOpacity: 1.0
                },
                position: newNode,
                label: {
                  text: sensor_id.toString(),
                  color: 'white'
                },
                id: i,
                gateway_id: gateway_name
              });
              markers[i] = marker;
              markers_location.push(marker);
              markerCluster1.addMarker(marker);
            }
          }
        }
      }
      addNetwork(markers,1);
    }
  });
}

/* draw links beween markers on page initialization */
function drawLink(gateway){
  $.ajax({
    url: "/api/topology",
    dataType: "json",
    success: function(jsonData){
      for(var i=1; i<jsonData.length; i++){
        if(jsonData[i] != null){
          var link_info = 0.01;
          var currentNodeLat = jsonData[i]['GPS_LAT'];
          var currentNodeLng = jsonData[i]['GPS_LONG'];
          var parentid = jsonData[i]['PARENT'];
          var parentidindex = jsonData.findIndex((v) => {
            return v.SENSOR_ID == parentid;
          });
          var gateway_name = jsonData[i]['GATEWAY_NAME'];
          if(gateway){
            if(gateway == gateway_name){
              if(parentid != null){
                var parentNodeLat = jsonData[parentidindex]['GPS_LAT'];
                var parentNodeLng = jsonData[parentidindex]['GPS_LONG'];
                var path = [
                {lat: currentNodeLat, lng: currentNodeLng},
                {lat: parentNodeLat, lng: parentNodeLng}
                ];
                var link = new google.maps.Polyline({
                  path: path,
                  strokeColor: '#000080',
                  strokeOpacity: 1.0,
                  strokeWeight: 1 + link_info * 100,
                  customInfo: link_info
                });
                links.push(link);
                if(link_info > 0.04){
                  link.strokeColor = '#800000';
                }
                createInfoWindow(link, "Link traffic : " + link.customInfo);
                link.setMap(map);
              }
            }
          }
          else{
            if(parentid != null){
              var parentNodeLat = jsonData[parentid]['GPS_LAT'];
              var parentNodeLng = jsonData[parentid]['GPS_LONG'];
              var path = [
              {lat: currentNodeLat, lng: currentNodeLng},
              {lat: parentNodeLat, lng: parentNodeLng}
              ];
              var link = new google.maps.Polyline({
                path: path,
                strokeColor: '#000080',
                strokeOpacity: 1.0,
                strokeWeight: 1 + link_info * 100,
                customInfo: link_info
              });
              links.push(link);
              if(link_info > 0.04){
                link.strokeColor = '#800000';
              }
              createInfoWindow(link, "Link traffic : " + link.customInfo);
              link.setMap(map);
            }
          }
        }
      }
    }
  })
}

/* update topology according to gateway name selection */
function updateGateway(){
  $('#gateway_names').change(function(){
    markerCluster1.clearMarkers();
    links.forEach(function(link){
      link.setMap(null);
    });
    var current_gateway = $('#gateway_names').val();
    drawTopology(current_gateway);
    drawLink(current_gateway);
  });
}

/* draw network stat */
function controlStat(){
  $('#statcontrolswitch').change(function(){
    if($('#statcontrolswitch').is(':checked')){
      $('#networkstatblock').show();
    }else{
      $('#networkstatblock').hide();
    }
  })
}

/* draw critial area on map */
var shape;
function drawCritical(){
  $('#myonoffswitch').change(function(){
    if($('#myonoffswitch').is(':checked')){
      shape = new google.maps.Polygon({
        paths: marker_critical,
        strokeColor: ' #FF5733 ',
        strokeOpacity: 0,
        strokeWeight: 0,
        fillColor: ' #FF5733 ',
        fillOpacity: 0.3,
        shapeType: 0,
      });
      shape.setMap(map);
    }else{
      shape.setMap(null);
    }
  })
}

/* add markers to network group by label identifier */
function addNetwork(markers,label){
  var app_per_avg_network  = sum_network_per / markers.length;
  var rssi_avg_network  = sum_network_rssi / markers.length;

  if(label==1){
    var sidebar = $('#demo');
    var sidebar_entry = $('<li/>', {
      'html': '<a href="#demo" class="btn btn-link" data-toggle="collapse">Network '+label
      +'<ul style="padding-left: 5px">Num. Nodes: '+(markers.length - 1 )+'</ul>'
      +'<ul id="network_per" style="padding-left: 5px">Avg. PER: '+app_per_avg_network.toFixed(6)+'</ul>'
      +'<ul id="network_rssi" style="padding-left: 5px">Avg. RSSI: '+rssi_avg_network.toFixed(6)+'</ul>'
      +'<ul style="padding-left: 5px">Energy status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Stability status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Security status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>',
    }).insertBefore(sidebar);
  }else if(label ==2){
    var sidebar2 = $('#demo2');
    var sidebar_entry2 = $('<li/>', {
      'html': '<a href="#demo2" class="btn btn-link" data-toggle="collapse">Network '+label
      +'<ul style="padding-left: 5px">Num. Nodes: '+(markers2.length - 1 )+'</ul>'
      +'<ul style="padding-left: 5px">Avg. PER: '+app_per_avg_network.toFixed(6)+'</ul>'
      +'<ul style="padding-left: 5px">Avg. RSSI: '+rssi_avg_network.toFixed(6)+'</ul>'
      +'<ul style="padding-left: 5px">Energy status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Stability status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>'
      +'<ul style="padding-left: 5px">Security status: '+'<meter min="0" low="0.2" high="0.5" optimum="1.0" max="1.0" value="'+(Math.random() * (0.8 - 0.1) + 0.1)+'">'+'</meter>'+'</ul>',
    }).insertBefore(sidebar2);
  }
}

/* add marker to topology */
var myinterval = null;
function addMarker(location,label,active,parent,gateway_id){
  var node_id = parseInt(label);
  var app_per_sum = 0;
  var rssi_sum = 0;
  var app_per_avg = 0;
  var rssi_avg = 0;
  var array_x = [];
  var array_y = [];
  var array = ['0'];
  var array_time = ['0'];
  var current = ['0'];
  var predict_y = ['0'];
  

  var marker = new google.maps.Marker({
    map: map,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 15,
      strokeWeight:2,
      fillColor: '#008000',
      fillOpacity: 1.0
    },
    position: location,
    label: label,
    id: label,
    gateway_id: gateway_id,
    status: active,
    customInfo: array,
    customInfoTime: array_time,
    parentInfo: parent,
    isCritical: 0,
    lossRate: 0,
    batteryInfo: Math.random() * (0.8 - 0.1) + 0.1
  });
  markers[parseInt(label)] = marker;
  markers_location.push(marker);
  markerCluster1.addMarker(marker);


  marker.addListener('click', function(){
    google.charts.setOnLoadCallback(drawChart2(this));
  });
  updateProgress();
}

/* draw legend on map initialization */
var legend = document.getElementById('legend');
for (var key in icons) {
  var type = icons[key];
  var name = type.name;
  var icon = type.icon;
  var div = document.createElement('div');
  div.innerHTML = '<img src="' + icon + '"> ' + name;
  legend.appendChild(div);
}
var c = document.getElementById("myCanvas");
var ctx = c.getContext("2d");
ctx.fillText("Low",5,12);
ctx.fillText("High",125,12);
ctx.fillText("Noisy zone (PER)",30,35);
var grd = ctx.createLinearGradient(0, 0, 170, 0);
grd.addColorStop(0, "white");
grd.addColorStop(1, " #ff5733");
ctx.fillStyle = grd;
ctx.fillRect(2, 15, 150, 10);

/* identify on-map blocks */
map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(mapreset);
map.controls[google.maps.ControlPosition.LEFT_TOP].push(gateway);
map.controls[google.maps.ControlPosition.LEFT_TOP].push(networkstatblockcontrol);
map.controls[google.maps.ControlPosition.LEFT_TOP].push(networkstatblock);
map.controls[google.maps.ControlPosition.RIGHT_TOP].push(noizy);
}

google.charts.load('current', {'packages':['annotatedtimeline']});

</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpPgcU1vPIge5zzD50cfVkL7DVpIVKac0&callback=initMap">
</script>



</body>

</html>
